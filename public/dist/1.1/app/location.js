define(function(require,exports,module){function e(){this.isWeChat=!!/MicroMessenger/gi.test(navigator.userAgent),this.isWinWeChat=!!/windowswechat/gi.test(navigator.userAgent),this.location={areaId:330102,lat:30.22965,lng:120.192567}}e.prototype.wxLocation=function(e){var t=this;return e=e||{},!t.isWeChat||t.isWinWeChat?(e.success&&e.success.call(t,t.location),!1):void require.async("weixin",function(c){t.wx=c,c.ready(function(){c.getLocation({type:"wgs84",success:function(c){console.info("[getLocation succeed]",c),t.location={lat:c.latitude,lng:c.longitude},e.success&&e.success.call(t,t.location)},fail:function(c){console.error("[getLocation failed]",c.errMsg),c.error="failed",e.fail&&e.fail.call(t,c)},cancel:function(c){console.warn("[getLocation user cancelled]",c),c.error="cancelled",e.fail&&e.fail.call(t,c)}})})})},e.prototype.searchNearBy=function(e){var t=this;e=e||{},t.wxLocation({success:function(c){AMap.service(["AMap.PlaceSearch"],function(){var o=new AMap.PlaceSearch,a=[c.lng,c.lat];o.searchNearBy("",a,500,function(c,o){var a=[];"OK"===o.info&&(a=o.poiList.pois,a.sort(function(e,t){return e.distance-t.distance})),e.success&&e.success.call(t,a)})})},fail:function(c){e.fail&&e.fail.call(t,c)}})},e.prototype.getLocation=function(e){var t=this;e=e||{};var c=localStorage.getItem(CONST.local_location);c&&(c=JSON.parse(localStorage.getItem(CONST.local_location)),e.success&&e.success.call(t,c)),t.wxLocation({success:function(o){AMap.service("AMap.Geocoder",function(){var a=new AMap.Geocoder,i=[o.lng,o.lat];a.getAddress(i,function(a,i){if(console.log(JSON.stringify(i)),"complete"===a&&"OK"===i.info){var n=i.regeocode,s=n.addressComponent,l={lng:o.lng,lat:o.lat,citycode:s.citycode,areaId:s.adcode,province:s.province,city:s.city,district:s.district,street:s.street,streetNumber:s.streetNumber,township:s.township,formattedAddress:n.formattedAddress};c?c.city!=l.city&&M.dialog({body:"您当前的定位城市为["+l.city+"]，是否切换?",buttons:[{text:"取消"},{text:"确定",class:"success",onClick:function(){localStorage.setItem(CONST.local_location,JSON.stringify(l)),location.reload()}}]}):(localStorage.setItem(CONST.local_location,JSON.stringify(l)),e.success&&e.success.call(t,l))}else c||e.fail&&e.fail.call(t,i)})})},fail:function(c){e.fail&&e.fail.call(t,c)}})},module.exports=new e});