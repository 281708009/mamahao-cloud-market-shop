define(function(require,exports,module){var a={config:{params:M.url.params(),hashParams:function(){return M.url.getParams((location.hash.match(/(\w+=)([^\&]*)/gi)||[]).join("&"))},api:{extra:"/api/goods_detail_extra"}},init:function(){var t=this,e=t.config,s=e.params;e.$container=$(".spa"),setTimeout(function(){M.lazyLoad.init()},250),M.swipe.init(),localStorage.getItem(CONST.local_cart_newGoods)&&$(".js-goods-cart").addClass("new"),e.params.vip?$(".m-goods-detail").prepend('<div class="history-back"><a href="//'+location.host+'/sale/">妈妈好 - 每月购</a><div'):$(".m-goods-detail").prepend('<div class="history-back"><a href="//'+location.host+'/">商城首页</a><div'),require.async("weixin",function(a){M.wx.share(a,{title:$(".js-share-title").text(),url:location.href,image:$("#swipe-banner img:first").data("share"),desc:$(".js-share-desc").text()})}),a.bindEvents(),M.ajax({showLoading:!0,url:e.api.extra,data:s?{data:JSON.stringify(s)}:{},success:function(a){var t=a.template;e.$container.append(t)}})},bindEvents:function(){var t=a.config,e=t.params,s=t.$container,i=e.templateId,o=JSON.parse(localStorage.getItem(CONST.local_qualityPic))||{};o[i]=$(".quality").data("pic"),localStorage.setItem(CONST.local_qualityPic,JSON.stringify(o));var n=$(".u-tab"),c=$("#swipe-detail .ui-swipe-item"),d=$(".m-goods-detail"),r=d.height()-n.height();c.height(r),s.on("click",".guide .ellipsis",function(){$(this).toggleClass("collapse")}),s.on("click",".js-modal",function(){var a=$($(this).data("target"));if(a.addClass("show"),a.hasClass("m-select-address")){var e=JSON.parse((new M.Base64).decode($.cookie(CONST.local_cookie_location)))||{};e.deliveryAddrId&&$("#add-"+e.deliveryAddrId).attr("checked","checked"),require.async("app/choose_pcd",function(a){t.PCD=new a({trigger:$(".js-select-gps"),confirmed:function(a){var t=JSON.parse((new M.Base64).decode(localStorage.getItem(CONST.local_store_gps)))||{},e={lat:t.lat,lng:t.lng,areaId:a.areaID,district:a.areaName,city:a.cityName,province:a.proName,formattedAddress:a.proName+a.cityName+a.areaName,timestamp:+new Date};t.city!=a.cityName&&(e.nolocal=!0),$.cookie(CONST.local_cookie_location,(new M.Base64).encode(JSON.stringify(e)),{expires:365,path:"/"}),M.reload()}}).init()})}}),s.on("click",".js-nav-list",function(){var a=$(this).next(),t=$("."+a.data("pop"));t.addClass("show"),t.find(".list").text()||t.find(".list").html(a.html())}),s.on("click",".js-voucher",function(){var a=$(this),t=a.closest("li").data("id");return!a.hasClass("ban")&&void M.ajax({url:"/api/coupons_receive",data:{tid:t},success:function(t){return 200!=t.success_code?M.tips(t.msg):(a.addClass("ban").text("已领取"),void M.tips({class:"true",body:"领取成功"}))},error:function(a){var t=a.msg;/^(-1)$/.test(a.error_code)&&(t="您还未登录，请登录后再试！"),M.tips(t)}})}),s.on("click",".m-select-address .list li",function(){var a=$(this),t=a.data("json"),e=JSON.parse((new M.Base64).decode(localStorage.getItem(CONST.local_store_gps)))||{};t.timestamp=+new Date,e.city&&e.city!=t.city&&(t.nolocal=!0),$.cookie(CONST.local_cookie_location,(new M.Base64).encode(JSON.stringify(t)),{expires:365,path:"/"}),M.reload()}),s.on("click",".m-select-address .gps",function(){$.removeCookie(CONST.local_cookie_location,{path:"/"}),M.reload()}),s.on("click",".mask, .js-close, .js-select-gps",function(){$(this).closest(".u-fixed").removeClass("show")}),s.on("click",".js-addToCart, .js-buy",function(){if($(this).hasClass("ban")||!s.find(".sku").data("sku-map"))return!1;var a=$(this).is(".js-buy")?"buy":"addToCart";require.async("app/sku",function(t){t.init(s.find(".sku")),s.find(".u-quantity .number").spinner(),s.find(".js-sku-confirm").data("action",a),$(".sku-sales")[e.vip?"hide":"show"](),s.find(".u-sku").addClass("show")})}),s.on("click",".sku-sales dd a",function(){var a=$(this);a.addClass("active").siblings().removeClass("active")}),s.on("click",".js-sku-confirm",function(){var t=$(this).data("action");switch(t){case"buy":a.buyNow();break;case"addToCart":a.addToCart()}}),s.on("click",".js-comment-pic li img",function(){var a=$(this),t=a.parents(".js-comment-pic");require.async("weixin",function(e){e.previewImage({urls:t.data("json"),current:a.data("pic")})})});var l=$(".js-bean-time");if(l.length){var u=l,p=Number(u.data("start")),m=Number(u.data("end")),f=Number(u.data("current"));console.log(p,m,f),p>f?($(".js-buy").addClass("ban"),u.timeCountDown({startDate:f,endDate:p,callback:function(){$(".js-buy").removeClass("ban"),u.timeCountDown({startDate:p,endDate:m,callback:function(){$(".js-buy").addClass("ban"),M.reload()}})}})):p<=f&&f<=m?($(".js-buy").removeClass("ban"),u.timeCountDown({startDate:f,endDate:m,callback:function(){$(".js-buy").addClass("ban"),M.reload()}})):($(".js-buy").addClass("ban"),u.html("已结束"))}},addToCart:function(){var t=a.config,e=t.params;require.async("app/sku",function(a){var s=a.selected();if(!s.itemId){var i=$.map($(".sku dl dt"),function(a){if(!$(a).closest("dl").find(".sku-key.active")[0])return $(a).text()})[0];return M.tips("请选择"+i)}var o=localStorage.getItem(CONST.local_cartId),n={cartId:o,jsonTerm:JSON.stringify([{isBindShop:!!e.shopId,itemId:s.itemId,shopId:e.shopId,templateId:e.templateId,companyId:e.companyId,count:+$(".u-sku .u-quantity .number").text(),pmtCode:t.params.vip?1:$(".sku-sales")[0]?+$(".sku-sales dd a.active").data("value"):0}]),pmtType:0};M.ajax({location:!0,url:"/api/addToCart",data:{data:JSON.stringify(n)},success:function(a){return 200!=a.success_code?M.tips(a.msg):(localStorage.setItem(CONST.local_cartId,a.cartId),M.tips({class:"true",body:"加入购物车成功"}),$(".u-sku .js-close").trigger("click"),localStorage.setItem(CONST.local_cart_newGoods,1),$(".js-goods-cart").addClass("new"),void 0)}})})},buyNow:function(){var t=a.config,e=t.params;require.async("app/sku",function(a){var s=a.selected();if(!s.itemId){var i=$.map($(".sku dl dt"),function(a){if(!$(a).closest("dl").find(".sku-key.active")[0])return $(a).text()})[0];return M.tips("请选择"+i)}var o=t.params.vip?1:$(".sku-sales")[0]?+$(".sku-sales dd a.active").data("value"):$(".monthly .nav-list")[0]?1:0,n={inlet:2==e.inlet?4:2,jsonTerm:JSON.stringify({itemId:s.itemId,templateId:e.templateId,count:+$(".u-sku .u-quantity .number").text(),shopId:e.shopId,companyId:e.companyId,isBindShop:e.shopId?1:0,pmtCode:o})},c="/settlement#/checkout/"+$.param(n);1===o&&(n.vip=1,c="/settlement#/selection/"+$.param(n)),location.href=c})}};a.init()});