define(function(require,exports,module){function e(){this.isWeChat=!!/MicroMessenger/gi.test(navigator.userAgent),this.isWinWeChat=!!/windowswechat/gi.test(navigator.userAgent),this.location={city:"杭州市",areaId:330102,lat:30.22965,lng:120.192567}}e.prototype.wxLocation=function(e){var o=this;return e=e||{},!o.isWeChat||o.isWinWeChat?(e.success&&e.success.call(o,o.location),!1):void require.async("weixin",function(t){o.wx=t,t.ready(function(){t.getLocation({type:"wgs84",success:function(t){console.info("[getLocation succeed]",t);var c=o.location={lat:t.latitude,lng:t.longitude};e.success&&e.success.call(o,c)},fail:function(t){console.error("[getLocation failed]",t.errMsg);var c=$.extend({},o.location);c.error="failed",e.success&&e.success.call(o,c)},cancel:function(t){console.warn("[getLocation user cancelled]",t),t.error="cancelled",e.fail&&e.fail.call(o,t)}})})})},e.prototype.searchNearBy=function(e){var o=this;e=e||{};var t=localStorage.getItem(CONST.local_store_gps),c=new M.Base64,a=t?JSON.parse(c.decode(t)):{};AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch,c=[a.lng,a.lat];t.searchNearBy("",c,500,function(t,c){var a=[];"OK"===c.info&&(a=c.poiList.pois,a.sort(function(e,o){return e.distance-o.distance})),e.success&&e.success.call(o,a)})})},e.prototype.getLocation=function(e){var o=this;require.async("cookie",function(){e=e||{};var t=localStorage.getItem(CONST.local_store_gps),c=$.cookie(CONST.local_cookie_location),a=new M.Base64;c&&(c=JSON.parse(a.decode(c)),e.success&&e.success.call(o,c),t&&c.timestamp&&+new Date-Number(c.timestamp)<864e5)||(t=t?JSON.parse(a.decode(t)):{},o.wxLocation({success:function(s){AMap.service("AMap.Geocoder",function(){var i=new AMap.Geocoder,n=[s.lng,s.lat];i.getAddress(n,function(i,n){if(console.log(JSON.stringify(n)),"complete"===i&&"OK"===n.info){var l=n.regeocode,r=l.addressComponent,d={lng:s.lng,lat:s.lat,citycode:r.citycode,areaId:r.adcode,province:r.province,city:r.city,district:r.district,street:r.street,streetNumber:r.streetNumber,township:r.township,formattedAddress:l.formattedAddress,timestamp:+new Date};console.info("重新获取过来的定位地址------>",d);var u=a.encode(JSON.stringify(d));e.success&&e.success.call(o,d),c?(t.city!=d.city&&o.saveLocation(u,"storage"),c.city!=d.city?M.dialog({body:"您当前的定位城市为["+d.city+"]，是否切换?",buttons:[{text:"取消",class:"",onClick:function(){c.timestamp=+new Date,c.nolocal=!0,o.saveLocation(a.encode(JSON.stringify(c)),"cookie")}},{text:"确定",class:"success",onClick:function(){o.saveLocation(u,"cookie"),M.reload()}}]}):c.nolocal&&(console.info("理论上不会走到这一步，多写一层防止错误"),c.timestamp=+new Date,delete c.nolocal,o.saveLocation(a.encode(JSON.stringify(c)),"cookie"))):(o.saveLocation(u),M.reload())}else c||e.fail&&e.fail.call(o,n)})})},fail:function(t){e.fail&&e.fail.call(o,t)}}))})},e.prototype.saveLocation=function(e,o){o&&"cookie"!=o||$.cookie(CONST.local_cookie_location,e,{expires:365,path:"/"}),o&&"storage"!=o||localStorage.setItem(CONST.local_store_gps,e)},module.exports=new e});