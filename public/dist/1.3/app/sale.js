define(function(require,exports,module){var o={tools:{},config:{fixed:1,pageSize:35,is:{},iScroll:{promise:!1,goods:!1,cart:!1},page:{promise:!1,goods:!1,cart:!1},goodEnd:!1},info:{},init:function(){var o=this,e=o.config,t=o.info;t.sale=$(".m-sale-all"),t.block=t.sale.find(".m-sale-block"),t.one=$(".m-sale-one"),t.two=$(".m-sale-two"),t.promise=$("#js-promise"),t.exp=$(".js-exp"),t.goods=$(".js-goods"),t.pageTip=$(".js-page-tip"),t.goodsTools=$("#js-goods-tools"),t.goCart=$(".js-go-cart"),t.cart=$("#js-cart"),t.cartContent=$("#js-cart-content"),t.more=$("#js-more"),t.details=$("#m-sale-pop-details"),t.cover=$("#js-sale-cover"),t.im=$(".js-open-im"),t.gps=$(".js-user-gps"),t.address=$(".m-select-address"),e.win=$(window),e.width=e.win.width(),e.height=e.win.height(),e.vm=VM,e.fixed=e.vm.fixed||1,e.goodType=e.vm.groupType,e.goodPage=1,o.size(),o.go(),o.bind(),e.vm.fixed!=-1&&o.welfareTime(),M.wx.shareData.url="//"+location.host+"/sale/"},size:function(){var o=this,e=o.config,t=o.info;t.block.height(e.height)},go:function(o){var e=this,t=e.config,i=e.info;switch(i.promise.off("touchend"),t.iScroll.promise&&t.iScroll.promise.destroy(),i.goods.off("touchend"),t.iScroll.goods&&t.iScroll.goods.destroy(),i.cart.off("touchend"),t.iScroll.cart&&t.iScroll.cart.destroy(),i.sale.removeAttr("style"),t.fixed=o||Number(t.fixed),t.fixed){case 1:i.one.addClass("IN"),e.promise.init();break;case 2:i.one.addClass("IN"),e.goods.init();break;case 3:e.cart.init()}$.hash.set("fixed",t.fixed)},promise:{init:function(){var e=this,t=o,i=t.info,s=t.config;i.one.removeClass("flex-column page-2").find(".i-scroll").removeAttr("style"),e.size(),s.iScroll.promise=new IScroll("#js-promise",{preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/},probeType:2}),e.bind();var n=i.promise.find(".footer");localStorage.getItem(CONST.local_sale_promise)&&n.length?(n.remove(),s.iScroll.promise.refresh()):n.length&&n.height()+n.offset().top-20>s.height?(n.remove(),s.iScroll.promise.refresh(),localStorage.setItem(CONST.local_sale_promise,"true")):localStorage.setItem(CONST.local_sale_promise,"true")},size:function(){var e=o,t=e.info,i=e.config,s=i.height-t.one.find(".header").height();t.promise.height(s).find(".promise-content").css({"min-height":s+2})},bind:function(){var e=o,t=e.info,i=e.config;i.iScroll.promise.on("scroll",function(){var o=this.scrollerHeight-this.wrapperHeight+this.y;o<=-i.pageSize?i.page.promise=!0:i.page.promise=!1}),t.promise.on("touchend",function(){i.page.promise&&e.go(2)})}},goods:{init:function(){var e=this,t=o,i=t.info,s=t.config;!s.page.cart&&s.page.promise?i.promise.removeAttr("style").css({transition:".2s","-webkit-transition":".2s",opacity:0}):s.page.promise||i.one.addClass("flex-column"),s.page.promise=!1,i.one.addClass("page-2"),e.size(),s.iScroll.goods=new IScroll("#js-goods",{preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/},probeType:2}),e.bind(),e.total()},size:function(){var e=o,t=e.info,i=e.config,s=i.height-t.one.find(".header").height()-110;t.goods.css({"min-height":s+2})},bind:function(){var e=this,t=o,i=t.info,s=t.config;s.iScroll.goods.on("scroll",function(){var o=this.scrollerHeight-this.wrapperHeight+this.y;s.goodEnd?o<=-s.pageSize?s.page.goods=!0:s.page.goods=!1:o<=-s.pageSize?i.pageTip.find("em").html("松开加载更多"):i.pageTip.find("em").html("下拉加载更多"),$(".js-goods-item").hasClass("del")&&$(".js-goods-item").removeClass("del"),console.log(s.page.goods)}),s.iScroll.goods.on("scrollEnd",function(){var o=this.scrollerHeight-this.wrapperHeight+this.y;o<=50&&e.page()}),i.goods.on("touchend",function(){s.page.goods&&t.go(3)})},total:function(){var e=o,t=e.info;e.config;M.ajax({showLoading:!1,url:"/api/sale/goods_total/",success:function(o){if(t.goodsTools.find(".li-1 del").html("￥"+o.price),t.goodsTools.find(".li-1 strong").html("￥"+o.pmtPrice),o.desc&&t.goodsTools.find(".js-tip").html('<div class="tip"><p>'+o.desc+"</p></div>"),o.popUps){var e=$(".m-monthly-pop"),i=o.popUps,s=0,n=i.length,a=[];for(a.push("<h2>"+o.title+'</h2><ul class="list">');s<n;s++)a.push('<li><div class="icon"><img src="'+i[s].icon+'" alt="'+i[s].title+'"></div><dl><dt>'+i[s].title+"</dt><dd>"+i[s].content+"</dd></dl></li>");a.push('</ul><button class="u-btn success max js-close">关闭</button>'),e.find(".content").html(a.join(""))}o.count>0&&t.goCart.html("<i>"+o.count+"</i>")}})},details:function(o){},page:function(){var e=this,t=o,i=t.info,s=t.config;if(!s.isAjax){var n=$("#js-group-list-"+s.goodType),a=n.data("json");if(s.goodPage<a.pageCount)s.goodPage++,s.isNewGroup=!1;else{if(!a.nextGroupType||a.nextGroupType==-1)return i.pageTip.find("em").html("上拉查看购物车"),void(s.goodEnd=!0);s.goodType=a.nextGroupType,s.goodPage=1,s.isNewGroup=!0}var r={groupType:s.goodType,page:s.goodPage};console.log(r),M.ajax({url:"/api/sale/group_page/",data:{data:JSON.stringify(r)},success:function(o){var t=e.isUnread(o.template);if(s.isNewGroup){var i=[],a=o.data;i.push('<div class="items" id="js-group-list-'+a.groupType+'" data-json='+JSON.stringify(a.pageConfig)+">"),i.push('<div class="title"><strong><span>'+a.groupName+"</span></strong></div>"),i.push('<ul class="items-content"></ul>'),i.push("</div>"),n.after(i.join("")),$("#js-group-list-"+a.groupType).find(".items-content").html(t)}else n.find(".items-content").append(t);s.iScroll.goods.refresh()}})}},shield:function(e,t){var i=o,s=(i.info,i.config),n=e.parents(".js-goods-item"),a=n.data("id"),r={monspGoodsId:a,neverShow:t};M.ajax({url:"/api/sale/goods_shield/",data:{data:JSON.stringify(r)},success:function(){n.remove(),s.iScroll.goods.refresh()}})},isUnread:function(o){var e=o?$(o):$(".js-goods-item"),t=JSON.parse(localStorage.getItem(CONST.local_sale_haveRead));if(e.each(function(){var o=$(this),e=o.data("id");t&&t.getIndex(e)!=-1||o.addClass("new")}),o)return e},haveRead:function(o){if(o){var e=JSON.parse(localStorage.getItem(CONST.local_sale_haveRead))||[];e.unshift(o),localStorage.setItem(CONST.local_sale_haveRead,JSON.stringify(e))}}},cart:{init:function(){var e=this,t=o,i=t.info,s=t.config;!M.url.query("fixed")&&i.sale.addClass("trans"),s.page.goods=!1,i.sale.css({"-webkit-transform":"translate3d(0, -"+s.height+"px, 0)",transform:"translate3d(0, -"+s.height+"px, 0)"}),e.size(),s.iScroll.cart=new IScroll("#js-cart",{preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/},probeType:2}),e.bind(),e.get()},size:function(e){var t=o,i=t.info,s=t.config,n=s.height-(e||0);i.cartContent.css({"min-height":n+2})},bind:function(){var e=o,t=e.info,i=e.config;i.iScroll.cart.on("scroll",function(){var o=this.y;o>=i.pageSize?i.page.cart=!0:i.page.cart=!1}),t.cart.on("touchend",function(){i.page.cart&&(t.cart.off("touchend"),t.sale.addClass("trans").css({"-webkit-transform":"translate3d(0, 0, 0)",transform:"translate3d(0, 0, 0)"}),e.go(2))}),i.iScroll.cart.on("scrollEnd",function(){i.page.cart&&this.destroy()})},get:function(){var e=this,t=o,i=t.info,s=t.config,n=$("#js-cart-tools");n.find(".info").show(),n.find(".delete").hide(),M.ajax({url:"/api/cart/",data:{data:JSON.stringify({vip:1})},success:function(o){i.cartContent.html(o.template),require.async("app/cart_home",function(o){o.init({refresh:function(){n.find(".m-cart-footer").length?(n.show(),e.size(50)):(n.hide(),e.size()),s.iScroll.cart.refresh()}}),s.iScroll.cart.refresh()})}})}},bind:function(){var o=this,e=o.config,t=o.info;t.cover.length?o.cover.init():o.newborn(),t.promise.transitionEnd(function(){t.one.addClass("flex-column"),t.promise.removeAttr("style").find(".i-scroll").removeAttr("style"),e.iScroll.goods.refresh(),t.exp.removeClass("merge")}),t.exp.on("touchstart","a",function(){t.exp.hasClass("merge")?(t.exp.removeClass("merge"),e.page.promise=!0,o.go(2)):(t.exp.addClass("merge"),o.go(1))}),t.promise.on("click",".js-show-city",function(){o.serviceCity($(this).data("json"))}),t.sale.transitionEnd(function(){t.one.find(".i-scroll").removeAttr("style"),e.page.cart&&(t.cart.find(".i-scroll").removeAttr("style"),e.page.cart=!1)}),t.more.on("click","dt a",function(o){o.preventDefault(),o.stopPropagation(),t.more.hasClass("show")||(t.more.addClass("show"),t.gps.hide()),M.im.easemobim||M.im.init()}),t.one.on("touchstart",function(o){var e=$(o.target);t.more.hasClass("show")&&!e.parents(".menu").length&&(t.more.removeClass("show"),t.gps.show()),M.tools.isAndroid&&e.parents(".js-avatar").length&&(window.location.href=e.parents(".js-avatar").attr("href"))}),t.goCart.on("click",function(){o.go(3)}),t.im.on("click",function(){M.im.track({desc:$("meta[itemprop=name]").attr("content")||"妈妈好·每月购",price:"",img_url:$("meta[itemprop=image]").attr("content")||"//img.mamhao.cn/s/common/images/icon-114.png",item_url:"//"+location.host+"/sale/"})}),t.goods.on("click",".item-delete",function(o){o.preventDefault(),o.stopPropagation(),$(this).parent().removeClass("del")}),t.goods.on("click",".js-hide",function(e){e.preventDefault(),e.stopPropagation(),o.goods.shield($(this),0)}),t.goods.on("click",".js-delete",function(e){e.preventDefault(),e.stopPropagation(),o.goods.shield($(this),1)}),t.goodsTools.on("click",".js-tip",function(){$(".m-monthly-pop").addClass("show")}),$(".m-monthly-pop").on("click",".js-close",function(){$(".m-monthly-pop").removeClass("show")}),o.goods.isUnread(),t.goods.on("click",".js-goods-item.new",function(e){e.preventDefault(),e.stopPropagation();var t=$(this),i=t.data("id");o.goods.haveRead(i),t.removeClass("new"),window.location.href=t.find("a").attr("href")}),t.goods.on("click",".js-goods-item .but-delete",function(o){o.preventDefault(),o.stopPropagation();var e=t.goods.find(".js-goods-item"),i=$(this).parent();i.hasClass("item")||(e.removeClass("del"),i.addClass("del"))}),t.gps.on("click",function(){o.address.show()}),$(window).on("hashchange",function(){var t=$.hash.getAll();t.fixed!=e.fixed&&(1==e.fixed&&(e.page.promise=!0),o.go(t.fixed))})},newborn:function(){var o=this,e=o.config;o.info;e.vm.popupWords&&M.dialog({className:"m-sale-pop-newborn",title:"<em>"+e.vm.nickName+"</em>",body:e.vm.popupWords+"<time>"+new Date(Number(e.vm.endTime)).format("yyyy-MM-dd")+"</time>",buttons:[{text:"我知道了",class:"success",onClick:function(){this.hide()}}]})},serviceCity:function(o){for(var e=this,t=(e.config,e.info,0),i=[];t<o.length;t++)i.push("<dl><dt>"+o[t].cityName+"：</dt><dd>"+o[t].areas+"</dd></dl>");M.dialog({className:"m-sale-pop-city",title:"<em>当前提供服务城市</em>",body:i.join(""),buttons:[{text:"我知道了",class:"alone",onClick:function(){this.hide()}}]})},welfareTime:function(){var o=this,e=(o.config,o.info,$(".js-welfare-time"));if(e.length){var t=e.data("current"),i=e.data("end"),s=M.date.diff(t,i);return Number(i)<=Number(t)?e.parent().remove():void(s<3?(s&&e.find("em").html(s+"天"),e.find("time").html('<span class="hour"></span><span class="minute"></span><span class="second"></span>').timeCountDown({endDate:i,startDate:t,callback:function(){M.reload()}})):s>=3&&e.html(s+"天"))}},cover:{config:{min:[0,0],max:[175,0],back:[100,0],newX:0,newY:0,opacity:1},info:{},init:function(){var e=this,t=e.info;e.config;t.cover=o.info.cover,t.move=t.cover.find(".js-move"),t.text=t.cover.find(".js-text"),e.bind(),e.time()},bind:function(){var o=this,e=o.info;$(window).on("touchmove",function(o){o.preventDefault()},!1),e.move.on("touchstart",function(e){o._start(e.originalEvent)}),e.cover.transitionEnd(function(){e.cover.remove()},!0),e.cover.on("click",function(t){e.move.css({transition:".2s","-webkit-transition":".2s"}),e.cover.css({transition:".4s","-webkit-transition":".4s"}),o.enter()}),e.cover.on("click",".logo",function(o){o.preventDefault(),o.stopPropagation(),M.dialog({className:"m-sale-pop-logo",title:'<img src="//img.mamhao.cn/s/m/images/bg-sale-logo-pop.jpg">',isMask:!0,body:'妈妈好·每月购是好孩子集团旗下会员服务品牌，专注为集团内部会员和妈妈好粉丝用户提供个性化、专业化、高品质、相互信赖的管家式服务。<div><img src="http://img.mamhao.cn/s/m/images/bg-sale-logo-pop-2.png"></div>',buttons:[{text:"取消"}]})})},_start:function(o){var e=this,t=e.info,i=e.config,s=o.touches?o.touches[0]:o;o.preventDefault(),o.stopPropagation(),i.initiated=!0,i.moved=!1,i.lastPointX=s.pageX,i.lastPointY=s.pageY,t.move.removeAttr("style"),t.cover.on("touchmove",function(o){e._move(o.originalEvent)}),t.cover.on("touchend",function(o){e._end(o.originalEvent)})},_move:function(o){var e,t,i=this,s=(i.info,i.config),n=o.touches?o.touches[0]:o;o.preventDefault(),o.stopPropagation(),s.moved=!0,e=n.pageX-s.lastPointX,s.lastPointX=n.pageX,t=n.pageY-s.lastPointY,s.lastPointY=n.pageY,s.newX=s.newX+e,s.newY=s.newY+t,s.newX<s.min[0]&&(s.newX=s.min[0]),s.newX>s.max[0]&&(s.newX=s.max[0]),i.css()},_end:function(o){var e=this,t=e.info,i=e.config;i.initiated&&(i.initiated=!1,o.preventDefault(),o.stopPropagation(),t.move.css({transition:".2s","-webkit-transition":".2s"}),i.newX<i.back[0]?(i.newX=i.min[0],e.css()):e.enter(),t.cover.off("touchmove"),t.cover.off("touchend"))},enter:function(){var e=this,t=e.info,i=e.config;if(i.newX=i.max[0],e.css(),$(window).off("touchmove"),t.move.off("touchstart"),t.cover.addClass("hide"),o.config.fixed==-1){var s={origin:location.origin+location.pathname+location.search};M.url.query("k")&&(s.k=M.url.query("k")),window.location.href="/account/bind/?"+$.param(s)}else o.newborn()},css:function(){var o=this,e=o.info,t=o.config;e.move.css({"-webkit-transform":"translate3d("+t.newX+"px,0,0)",transform:"translate3d("+t.newX+"px,0,0)"}),e.text.css({opacity:t.opacity-t.newX/t.max[0]})},time:function(){var o=this,e=(o.config,o.info),t=e.cover.find(".time");if(t.length){var i=t.data("current"),s=t.data("end"),n=M.date.diff(i,s),a=["距结束 "];Number(s)<=Number(i)||(n<3?(n&&a.push(n+"天"),a.push('<span class="hour"></span>:<span class="minute"></span>:<span class="second"></span>'),t.html(a.join("")).timeCountDown({endDate:s,startDate:i,callback:function(){M.reload()}})):(a.push(n+"天"),t.html(a.join(""))))}}},address:{show:function(){var e=o,t=e.info;e.config;t.address.find(".list li").length?t.address.addClass("show"):(this.get(),this.set(),t.address.on("click",".js-close,.js-select-gps",function(){t.address.removeClass("show")}),t.address.on("click",".js-gps-address",function(){$.removeCookie(CONST.local_sale_areaId,{path:"/"}),M.reload()}))},get:function(){var e=o,t=e.info,i=e.config;M.ajax({url:"/api/myAddress",success:function(o){t.address.addClass("show").find(".list").html(o.template);var e=$.cookie(CONST.local_sale_areaId);e&&(e=JSON.parse(e),e.deliveryAddrId&&$("#add-"+e.deliveryAddrId).attr("checked","checked")),require.async("app/choose_pcd",function(o){i.PCD=new o({trigger:$(".js-select-gps"),confirmed:function(o){var e=JSON.stringify(o);$.cookie(CONST.local_sale_areaId,e,{expires:365,path:"/"}),M.reload()}}).init()})},error:function(o){}})},set:function(){var e=o,t=e.info;e.config;t.address.on("change",".u-checkbox",function(){var o=$(this).parents("li"),e=o.data("json"),t=JSON.stringify({areaID:e.areaId,areaName:e.area,deliveryAddrId:e.deliveryAddrId});$.cookie(CONST.local_sale_areaId,t,{expires:365,path:"/"}),M.reload()})}}};o.init(),window.Sale=o,module.exports=o});