define(function(require,exports,module){function t(t,e){this.page=t,this.container=e}module.exports=t,t.prototype.render=function(){var t=this;t.page;t.bind()},t.prototype.stockOut=function(t,e){var a=localStorage.getItem(CONST.local_settlement_addr);if(a&&(a=JSON.parse(a),localStorage.removeItem(CONST.local_settlement_addr)),14001==t||3119==t)location.href="/cart";else if(e&&e.length>0){var n=['<div class="goods-list"><ul>'];for(i=0;i<e.length;i++){var s=e[i],c="";$.each(s.spec,function(t){t>0&&(c+=","),c+=this.value}),n.push("<li>"),n.push('<div class="pic"><img src="'+s.itemPic+'@1e_200w_200h_0c_0i_0o_100q_1x.jpg"><em>暂时缺货</em></div>'),n.push("<dl><dt>"+s.itemTitle+"</dt><dd><span>"+c+"</span>"),s.isGift?n.push("<em>赠品</em>"):n.push("<strong>￥"+s.showPrice+"</strong>"),n.push("</dd></dl></li>")}n.push("</ul></div>"),M.dialog({className:"m-cart-lack",title:"您选购的以下商品缺货",body:n.join(""),buttons:[{text:"找相似商品",class:"",onClick:function(){location.href="/"}},{text:"继续结算",class:"success",onClick:function(){this.hide(),M.reload()}}]})}else a?M.dialog({body:"商品在该区域暂时缺货",buttons:[{text:"修改地址",class:"",onClick:function(){location.href="/center#/address/f=1&id="+a.deliveryAddrId}},{text:"我知道了",class:"success",onClick:function(){this.hide(),history.length?history.go(-1):location.href="/cart"}}]}):M.dialog({body:"商品在该区域暂时缺货",buttons:[{text:"找其他商品",class:"",onClick:function(){location.href="/"}},{text:"我知道了",class:"success",onClick:function(){this.hide(),history.length?history.go(-1):location.href="/cart"}}]})},t.prototype.fillData=function(t){var e=this,i=e.container;console.log(t);var a=[];a.push('<a class="u-arrow right" href="/center#/address/f=1&amp;id='+t.deliveryAddrId+'">'),t.isDefult?a.push('<dl class="default"><dt><strong>'):a.push("<dl><dt><strong>"),a.push(t.consignee+"</strong><em>"+t.phone+"</em></dt><dd>"+t.addr),a.push("</dd></dl></a>"),$(".js-address").html(a.join("")),i.find('[name="deliveryAddrId"]').val(t.deliveryAddrId)},t.prototype.getFormData=function(){var t=this,e=t.container,i=e.find(".js-delivery").data("delivery"),a=e.find('[name="deliveryAddrId"]'),n=e.find(".js-vouchers"),s=$('.open input[name="mbean"]'),c=$('.open input[name="gbCount"]'),o=$('.open input[name="mcCount"]');$("#mbean").find(".u-switch:checked").length&&(s=$('input[name="mbean"]'));var d={orderBatchNo:e.find('[name="orderNo"]').val(),dealingType:1,madouCount:s.length?+s.val():0,gbCount:c.length?+c.val():0,mothercareCount:o.length?+o.val():0};a.length&&(d.deliveryAddrId=a.val()),i&&(d.deliveryWays=JSON.stringify(i));var l={},r=$(".js-invoice").data("type");return l.invoiceType=r||0,/(1|2)/.test(r)&&(l.invoiceName=$(".js-invoice").data("name")),d.invoice=JSON.stringify(l),n.length&&n.data("ids")&&(d.voucherIds=""+n.data("ids")),d},t.prototype.calcu=function(){var t=+$('[name="payPrice"]').val(),e=+$('[name="mailPrice"]').val(),i=($(".js-point").data("totalDiscount"),$(".js-vouchers").length?$(".js-vouchers").data("discount"):0),a=$('[name="finalPrice"]'),n=$('.open input[name="mbean"]'),s=$('.open input[name="gbCount"]'),c=$('.open input[name="mcCount"]'),o=n.length?M.calc.divide(n.val(),n.data("ratio")):0,d=s.length?M.calc.divide(s.val(),s.data("ratio")):0,l=c.length?M.calc.divide(c.val(),c.data("ratio")):0,r=M.calc.add(M.calc.add(M.calc.add(i,o),d),l),u=M.calc.subtract(t,r);$("#deliveryFee:visible").length?($(".js-finalPrice").html("￥"+(u+e)),a.val(u+e)):($(".js-finalPrice").html("￥"+u),a.val(u)),$.each($(".js-point li").not(".open"),function(){if($(this).find(".u-switch").is(".disabled"))return!1;var e=$(this).find('input[type="tel"]'),i=e.data("ratio"),a=e.data("max"),n=M.calc.subtract(t,r),s=a;s="mcCount"==e.attr("name")?100*Math.floor(n*i/100):M.calc.multiply(n,i);var c=a<s?a:s;e.data("useable",c),e.val(c),e.next().html("￥"+M.calc.divide(c,i)),e.prev().html(c),$(this).find(".u-switch").is(".disabled")||(0==c?$(this).find(".u-switch").addClass("diabled").attr("disabled",!0):$(this).find(".u-switch").removeClass("diabled").attr("disabled",!1))})},t.prototype.bind=function(){var t=this,e=t.container,i=($(".spa"),$("#settlement")),a=i.data("stockout");if(a&&0!=a)return void t.stockOut(a,i.data("stockoutGoods"));var n=localStorage.getItem(CONST.local_settlement_addr);n&&(n=JSON.parse(n),t.fillData(n)),$('[name="payPrice"]')[0]&&(t.calcu(),e.on("click",".mask",function(){$(this).closest(".u-fixed").removeClass("show")}),e.on("click",".js-cancel",function(){$(this).closest(".u-fixed").removeClass("show")}),e.on("click",".js-modal",function(){var t=$($(this).data("target"));t.addClass("show")}),e.on("click",".m-invoice-pop dd em",function(){var t=$(this),e=t.index(),i=t.data("txt");t.addClass("active").siblings().removeClass("active"),2!==e?($(".invoice-cont").removeClass("none"),0==e?$(".invoice-cont").find("input").val(i):$(".invoice-cont").find("input").val("")):$(".invoice-cont").addClass("none")}),e.on("click",".js-confirm-invoice",function(){var t=$(".invoice-type em.active"),e=+t.data("type"),i=$(".invoice-cont input"),a=$.trim(i.val()),n={type:e};if(/(1|2)/.test(e)){if(!a)return M.tips("请输入发票抬头");n.name=a}$(".js-invoice").data(n).find("em").text(t.text()),$(this).closest(".u-fixed").removeClass("show")}),e.on("click",".js-btn-delivery",function(){if(!$(this).is(".checked")){var e=$(this).closest(".js-delivery-item"),i=$(this).data("type");e.find("button[data-type="+i+"]").addClass("checked").siblings().removeClass("checked"),e.find(".js-tips[for="+i+"]").slideDown().siblings(".js-tips").slideUp();var a=[];$(".js-btn-delivery.checked").each(function(){a.push($(this).data("type"))}),a.getIndex(1)==-1&&a.getIndex(3)==-1?$("#deliveryFee").hide():$("#deliveryFee").show(),t.calcu()}}),e.on("click",".js-ok",function(){var t=[],i=[];e.find(".js-delivery-item").each(function(){var e=$(this);t.push({type:e.data("type"),sid:e.data("id"),deliveryWay:e.find("button.checked").data("type")}),i.getIndex(e.find("button.checked").text())===-1&&i.push(e.find("button.checked").text())}),i=i.join(" + "),$(".js-delivery").data("delivery",t).find("em").html(i),$("#delivery-ways").removeClass("show")}),e.on("click",".js-coupon-item",function(){$(".open").each(function(){$(this).find(".u-switch").trigger("click")}),$(".u-radio:checked").prop("checked",!1);var e=$(this).data("id"),i=$(this).data("discount");e?$(".js-vouchers").data({ids:e,discount:i}).html("省"+i+"元"):$(".js-vouchers").data({ids:null,discount:0}).html("不使用优惠券"),$(this).find(".u-radio").prop("checked",!0),$("#coupon").removeClass("show"),t.calcu()}),e.on("click",".u-switch",function(){if(!$(this).is(".disabled")){if($(this).is(":checked")){$(this).closest("li").addClass("open");var e=$(this).closest("li").find('input[type="tel"]');e.val(e.data("useable"))}else{$(this).closest("li").removeClass("open");var i=$(this).closest("li").find(".js-point-discount-display");i.html("￥"+i.data("max"))}t.calcu()}}),e.on("input",'.js-point input[type="tel"]',function(){var e=$(this),i=e.data("useable");""==e.val()||(e.val()>i||!/^[1-9]+\d*$/.test(e.val()))&&e.val(i),e.next().html("￥"+e.val()/e.data("ratio")),t.calcu()}),e.on("change",'.js-point input[type="tel"]',function(){var e=$(this),i=e.data("useable");""==e.val()?e.closest("li").find(".u-switch").trigger("click"):e.val()>i&&e.val(i),"mcCount"==e.attr("name")&&(0==~~M.calc.divide(e.val(),100)?e.val(100):e.val(100*~~M.calc.divide(e.val(),100))),e.next().html("￥"+e.val()/e.data("ratio")),t.calcu()}),e.on("click",".js-pay",function(){var e=t.getFormData();return e.deliveryAddrId?0==+$('[name="finalPrice"]').val()?void M.dialog({body:"全妈豆支付请下载妈妈好APP",buttons:[{text:"我知道了",class:"",onClick:function(){this.hide()}},{text:"下载APP",class:"success",onClick:function(){this.hide(),location.href="http://app.mamahao.com"}}]}):void M.ajax({url:"/api/pay",data:{data:JSON.stringify(e)},success:function(t){200==t.success_code&&M.pay.order(t.orderBatchNo)}}):alert("请填写收货地址")}),e.on("click",".js-inspect-pay",function(){var e=t.getFormData();return 0==+$('[name="finalPrice"]').val()?void M.dialog({body:"全妈豆支付请下载妈妈好APP",buttons:[{text:"我知道了",class:"",onClick:function(){this.hide()}},{text:"下载APP",class:"success",onClick:function(){this.hide(),location.href="http://app.mamahao.com"}}]}):void M.ajax({url:"/api/order/pay",data:{data:JSON.stringify(e)},success:function(t){200==t.success_code&&M.pay.order(t.orderBatchNo,2)}})}))}});