define(function(require,exports,module){var e={config:{api:{selectedCart:"/api/cart/opt/selectedCart",removeCartItem:"/api/cart/opt/removeCartItem",cleanCart:"/api/cart/opt/cleanCart",updateCartItemCount:"/api/cart/opt/updateCartItemCount",changeSKU:"/api/cart/changeSKU",getSKU:"/api/goods_sku",getRecommendList:"/api/cart/getRecommendList"},elements:{cartModule:".cart-goods-module"}},init:function(e){var t=this,s=t.config.api;$.extend(t.config,e),t.params={cartId:localStorage.getItem(CONST.local_cartId),vip:+$('input[name="frVIP"]').val()},t.fn_renderFooter(),t.bindEvents(),localStorage.removeItem(CONST.local_cart_newGoods),$(".u-goods-list").length&&$.pagination({container:".u-goods-list",keys:{count:"pageSize"},scrollBox:".js-cart-content",api:s.getRecommendList,fnSuccess:function(e,t){var s=e.data;if(!s.template)return t.data("locked",!0);var c=$(s.template);t.append(c)}})},optAjaxReqHandler:function(e,t,s){var c=this,a=c.config.api,i=c.config.elements,o=$(i.cartModule);t.isEdit=$(".valid-list.edit").length,M.ajax({location:!0,url:a[e],data:{data:JSON.stringify(t)},success:function(e){o.html(e.template),c.fn_renderFooter(),0==$(".valid-list").length&&$(".random-list").show(),s&&"function"==typeof s&&s()}})},bindEvents:function(){var t=this,s=t.params,c=$(".js-cart-content, #app"),a=$("#js-cart-footer, #js-cart-tools"),i={editBtn:".js-edit",saveBtn:".js-save",checkAll:".js-select-all",checkbox:".js-checkbox",editCheckAll:".js-edit-checkAll",editDeleteBtn:".js-edit-del.success",deleteIcon:".js-del",clearBtn:".js-clear",updateCountBtn:".js-update",editSKUBtn:".sku-edit",addToCartBtn:".js-add-cart"};c.on("click",".mask, .js-close",function(e){$(this).closest(".u-fixed").removeClass("show")}),c.off("click",i.editBtn).on("click",i.editBtn,function(){$(this).removeClass("edit js-edit").addClass("save js-save").html("完成"),$(".random-list").hide(),$(".valid-list").addClass("edit"),$(".delete").show(),$(".m-cart-footer .info").hide(),$(".u-edit-checkbox, .js-edit-checkAll").prop("checked",!1),$(".js-edit-checkAll").next().html("全选"),$(".js-edit-del").removeClass("success").addClass("ban")}),c.off("click",i.saveBtn).on("click",i.saveBtn,function(){$(this).removeClass("save js-save").addClass("edit js-edit").html("编辑"),$(".random-list").show(),$(".valid-list").removeClass("edit"),$(".delete").hide(),$(".m-cart-footer .info").show()}),a.off("click",i.checkAll).on("click",i.checkAll,function(e){if(!$(this).closest(".edit").length){var c=$(this).find(".u-checkbox:visible").is(":checked")?2:3,a=$.extend(!0,s,{isSelected:c});t.optAjaxReqHandler("selectedCart",a)}}),c.off("click",i.checkAll).on("click",i.checkAll,function(e){if(!$(this).closest(".edit").length){var c=$(this).find(".u-checkbox:visible").is(":checked")?2:3,a=$.extend(!0,s,{isSelected:c});t.optAjaxReqHandler("selectedCart",a)}}),c.off("click",i.editCheckAll).on("click",i.editCheckAll,function(e){$(this).is(":checked")?($(".u-edit-checkbox").prop("checked",!0),$(".js-edit-del").addClass("success").removeClass("ban"),$(".js-edit-checkAll").prop("checked",!0).next().html("全选(已选"+$(".js-item .u-checkbox:visible:checked").length+")")):($(".u-edit-checkbox").prop("checked",!1),$(".js-edit-del").addClass("ban").removeClass("success"),$(".js-edit-checkAll").prop("checked",!1).next().html("全选"))}),c.off("click",i.checkbox).on("click",i.checkbox,function(e){if(e.stopPropagation(),$(this).closest(".edit").length)$(".u-edit-checkbox:checked").length?($(".js-edit-del").addClass("success").removeClass("ban"),$(".js-edit-checkAll").next().html("全选(已选"+$(".js-item .u-checkbox:visible:checked").length+")"),$(".u-checkbox:visible:checked").length==$(".u-checkbox:visible").length||$(".js-item .u-checkbox:visible").length==$(".js-item .u-checkbox:visible:checked").length?$(".js-edit-checkAll").prop("checked",!0):$(".js-edit-checkAll").prop("checked",!1)):($(".js-edit-del").addClass("ban").removeClass("success"),$(".js-edit-checkAll").next().html("全选"));else{var c=$(this).closest(".js-item"),a=$(this).find(".u-checkbox:visible").is(":checked")?0:1,i=$.extend(!0,s,{isSelected:a,compoentId:"undefined"!=typeof $(this).closest("li").data("compoentId")?$(this).closest("li").data("compoentId"):c.data("compoentId")});t.optAjaxReqHandler("selectedCart",i)}}),c.off("click",i.editDeleteBtn).on("click",i.editDeleteBtn,function(e){e.stopPropagation();var c=($(this).closest(".item"),[]),a=[];$(".u-edit-checkbox:checked").each(function(e,t){var s=$(t).closest(".js-item");s.length&&(a.push(s[0]),c.push({compoentType:s.data("compoentType"),compoentId:s.data("compoentId")}))});var i=$.extend(!0,s,{jsonTerm:JSON.stringify(c)}),o="确定要将这"+c.length+"个宝贝删除?";confirm(o,function(){this.hide(),t.optAjaxReqHandler("removeCartItem",i,function(){$(".u-edit-checkbox, .js-edit-checkAll").prop("checked",!1),$(".js-edit-checkAll").next().html("全选"),$(".js-edit-del").removeClass("success").addClass("ban")})})}),c.off("click",i.deleteIcon).on("click",i.deleteIcon,function(e){e.stopPropagation();var c=$(this).closest(".js-item"),a=$.extend(!0,s,{jsonTerm:JSON.stringify([{compoentType:$(this).closest("li").data("compoentType")||c.data("compoentType"),compoentId:"undefined"!=typeof $(this).closest("li").data("compoentId")?$(this).closest("li").data("compoentId"):c.data("compoentId")}])}),i=$(this).data("tips");confirm(i,function(){this.hide(),t.optAjaxReqHandler("removeCartItem",a)})}),c.off("click",i.clearBtn).on("click",i.clearBtn,function(e){e.stopPropagation();var c=$(this).data("tips"),a=$.extend(!0,s,{removeType:2});confirm(c,function(){this.hide(),t.optAjaxReqHandler("cleanCart",a)})}),c.off("click",i.updateCountBtn).on("click",i.updateCountBtn,function(e){e.stopPropagation();var c=($(this),$(this).closest(".js-item")),a=+$(this).data("count");if(a<=0||$(this).is(".disabled")){if($(this).data("tips"))return alert($(this).data("tips"))}else{var i=$.extend(!0,s,{newCount:a,compoentId:"undefined"!=typeof $(this).closest("li").data("compoentId")?$(this).closest("li").data("compoentId"):c.data("compoentId")});t.optAjaxReqHandler("updateCartItemCount",i)}}),c.off("click",".sku-sales dd a").on("click",".sku-sales dd a",function(){var e=$(this);e.addClass("active").siblings().removeClass("active")}),c.off("click",".js-sku-confirm").on("click",".js-sku-confirm",function(c){var a=$(this),i=$(".js-sku.current").closest(".goods"),o=(i.closest(".item"),e.curItem,localStorage.getItem(CONST.local_cartId));require.async("app/sku",function(e){var c=e.selected();if(!c.itemId){var l=$.map($(".sku dl dt"),function(e){if(!$(e).closest("dl").find(".sku-key.active")[0])return $(e).text()})[0];return M.tips("请选择"+l)}i.attr("data-item-id",c.itemId).attr("data-price",c.detail.price).attr("data-oprice",c.detail.oprice).find(".spec").addClass("selected").text("已选"+c.desc.join(",")),a.closest(".u-sku").find(".js-close").trigger("click");var n={};$(".valid-list.edit").length?(n={cartId:o,jsonTerm:JSON.stringify([{itemId:s.itemId,compoentId:s.compoentId,newItemId:c.itemId,pmtCode:$(".sku-sales")[0]?+$(".sku-sales dd a.active").data("value"):0}])},t.optAjaxReqHandler("changeSKU",n)):(n={cartId:o,jsonTerm:JSON.stringify([{itemId:c.itemId,templateId:s.templateId,count:+$(".u-sku .u-quantity .number").text(),pmtCode:$(".sku-sales")[0]?+$(".sku-sales dd a.active").data("value"):0}]),pmtType:0},M.ajax({location:!0,url:"/api/addToCart",data:{data:JSON.stringify(n)},success:function(e){return 200!=e.success_code?M.tips(e.msg):(localStorage.setItem(CONST.local_cartId,e.cartId),M.tips({body:"加入购物车成功",class:"true"}),$(".u-sku .js-close").trigger("click"),void 0)}}))})}),c.off("click",i.editSKUBtn).on("click",i.editSKUBtn,function(){var t=$(this).closest(".item");e.curItem=t;var c=t.data("templateId"),a=t.data("itemId"),i=t.data("compoentId");if(s.templateId=c,s.itemId=a,s.compoentId=i,c===$(".js-sku-confirm").data("template-id"))return $(".u-sku").addClass("show"),!1;var o={inlet:6,templateId:c};M.ajax({location:!0,url:"/api/goods_sku",data:{data:JSON.stringify(o)},success:function(e){$(".u-sku").find(".content").empty().append(e.template),require.async("app/sku",function(e){e.init($(".sku")),$(".js-sku-confirm").data("template-id",c),$(".quantity").remove(),$(".u-sku").addClass("show")})}})}),c.off("click",".box").on("click",".box",function(){var e=$(this).closest(".item");if(!$(this).closest(".edit").length){var t="/goods/detail/?inlet=6&templateId="+e.data("templateId")+"&itemId="+e.data("itemId");s.vip&&(t+="&vip="+s.vip),location.href=t}}),c.off("click",i.addToCartBtn).on("click",i.addToCartBtn,function(){var e=$(this).closest("li").data("templateId");if(s.templateId=e,e===$(".js-sku-confirm").data("template-id"))return $(".u-sku").addClass("show"),!1;var t={inlet:6,templateId:e};M.ajax({location:!0,url:"/api/goods_sku",data:{data:JSON.stringify(t)},success:function(t){$(".u-sku").find(".content").empty().append(t.template).end().addClass("show"),require.async("app/sku",function(t){t.init($(".sku")),$(".u-quantity .number").spinner(),$(".js-sku-confirm").data("template-id",e)})}})})},fn_renderFooter:function(){var e=this;if(!$(".cart-goods-module .valid-list").length)return $(".m-cart-footer").remove(),$(".m-cart-tools").remove(),void(e.config.refresh&&e.config.refresh());var t={allSelected:+$('input[name="allSelected"]').val(),totalPrice:+$('input[name="totalPrice"]').val(),disPrice:+$('input[name="disPrice"]').val(),goodsCount:+$('input[name="goodsCount"]').val(),hasMonthItem:+$('input[name="hasMonthItem"]').val(),frVIP:+$('input[name="frVIP"]').val()},s=[];return s.push('<ul class="field">'),t.allSelected?s.push('<li class="li-1"><label class="js-select-all"><input class="u-checkbox" type="checkbox" checked="checked"><em>全选</em></label></li>'):s.push('<li class="li-1"><label class="js-select-all"><input class="u-checkbox" type="checkbox"><em>全选</em></label></li>'),s.push('<li class="li-2"><dl><dt>合计：<strong>￥ '+t.totalPrice+"</strong></dt><dd>为您节省 ￥ <span>"+t.disPrice+"</span></dd></dl></li>"),0===t.goodsCount?s.push('<li class="li-3"><a class="u-btn ban" href="javascript:;">结算<span>('+t.goodsCount+")</span></a></li>"):$(".vip :checked").length?s.push('<li class="li-3"><a class="u-btn success" href="/settlement#/selection/vip=1">结算<span>('+t.goodsCount+")</span></a></li>"):s.push('<li class="li-3"><a class="u-btn success" href="/settlement#/checkout/">结算<span>('+t.goodsCount+")</span></a></li>"),s.push("</ul>"),$(".m-cart-footer .info").html(s.join("")),e.config.refresh&&e.config.refresh(),$(".m-cart-footer .info")}};module.exports=e});