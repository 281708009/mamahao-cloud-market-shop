define(function(require,exports,module){var e={config:{params:M.url.params(),hashParams:function(){return M.url.getParams((location.hash.match(/(\w+=)([^\&]*)/gi)||[]).join("&"))},api:{profile_update:"/api/profile_update",profile_geo_update:"/api/profile_geo_update",breed_add:"/api/breed_add",breed_update:"/api/breed_update",breed_delete:"/api/breed_delete",update_profile_cache:"/api/update_profile_cache"}},init:function(){e.bindEvents()},bindEvents:function(){var a=e.config,t=$(".spa");return/#\/profile$/gi.test(location.hash)?(require.async("app/choose_pcd",function(i){new i({container:t,trigger:$(".js-district"),confirmed:function(t){$(".js-district").val([t.proName,t.cityName,t.areaName].join("-")),M.ajax({url:a.api.profile_geo_update,data:{data:JSON.stringify({areaId:t.areaID})},success:function(){console.info("geo update success!"),e.updateProfileCache()}})}}).init()}),t.on("blur",".js-nickname",function(){var t=$(this),i=t.data("val"),n=t.val();if(n!==i){if(!n)return M.tips("输入不能为空");if(!/^[\u4e00-\u9fa5_a-zA-Z0-9]+$/.test(n))return M.tips("只支持汉字，英文和数字");M.ajax({url:a.api.profile_update,data:{data:JSON.stringify({nickname:n})},success:function(){console.info("nickname update success!"),t.data("val",n),e.updateProfileCache()}})}}),$(".js-babies").touchwipe({wipeLeft:function(e){$(".js-babies.delIn").removeClass("delIn").addClass("delOut"),e.removeClass("delOut").addClass("delIn")},wipeRight:function(e){e.hasClass("delIn")&&e.removeClass("delIn").addClass("delOut")}}),$(".js-babies").on("click",".delete",function(){var t=$(this).data("id"),i={};t&&(i={babyId:t}),M.ajax({url:a.api.breed_delete,data:{data:JSON.stringify(i)},success:function(){e.updateProfileCache(function(){M.reload()})}}),console.log()}),!1):(t.on("click",".u-checkbox",function(){var e=$(this).data("section");if($(".section").addClass("none"),e&&$(e).removeClass("none"),$(".datetime-picker").data("picker",null),/^.(baby|prepare)$/.test(e)){var a=$(".picker-modal.modal-in");a&&a.trigger("close")}}),t.on("change",".babyGender",function(){var e=$(this);e.val();$(".babyGenderShow").text(e.find("option:selected").text()).data("val",e.val()).addClass("val")}),t.on("click",".js-submit",function(){e.breedSave()}),t.on("click",".js-delete",e.breedDelete),void require.async("picker",function(){var a={container:t,format:"yyyy-MM-dd",level:3,atOnce:!1},i={affix:!0,toolbarTitle:"请选择预产期",toolbarCloseText:"",ifClose:function(e){var a=+new Date((new Date).format("yyyy/MM/dd")),t=+new Date(e.value[0],e.value[1]-1,e.value[2]),i=a+24192e6;return!(t<a||t>i)||(M.tips("请选择合理的预产期"),!1)},onConfirm:function(a){e.breedSave({duaDate:a.string})}};$(".u-checkbox:checked").is(".datetime-picker-mother")&&(i.appear=!0);var n={mask:!0,toolbarTitle:"请选择宝宝生日",ifClose:function(e){var a=new Date,t=+new Date(a.format("yyyy/MM/dd")),i=+new Date(e.value[0],e.value[1]-1,e.value[2]),n=+new Date(a.getFullYear()-14,a.getMonth(),a.getDay());return!(i>t||i<n)||(M.tips("请选择正确的宝宝生日"),!1)},onConfirm:function(e){e.input.text(e.string).data("val",e.string).addClass("val")}};$(".babyGenderShow").picker({mask:!0,atOnce:!1,toolbarTitle:"请选择宝宝性别",cols:[{values:["王子","公主"]}],onConfirm:function(e){e.input.val(e.value.join("")).addClass("val")}}),$(".babyGenderShow,.babyBirthday").on("touchstart",function(){$(".babyName").blur()}),$(".datetime-picker-mother").datetimePicker($.extend({},a,i)),$(".datetime-picker-baby").datetimePicker($.extend({},a,n))}))},breedSave:function(a){var t=e.config,i=t.hashParams(),n={status:$(".u-checkbox:checked").data("status")};switch(n.status){case 1:break;case 2:n.baby={babyName:$(".babyName").val(),babyBirthday:$(".babyBirthday").data("val")};var r=$(".babyGenderShow").val();if(r&&("王子"==r?n.baby.babyGender=1:n.baby.babyGender=2),console.log(n.baby),i.id&&(n.baby.babyId=i.id),!n.baby.babyName)return M.tips("请输入宝宝昵称");if(!/^[\u4e00-\u9fa5_a-zA-Z0-9]+$/.test(n.baby.babyName))return M.tips("宝宝昵称只支持汉字，英文和数字");if(!n.baby.babyGender||n.baby.babyGender==-1)return M.tips("请选择宝宝性别");if(!n.baby.babyBirthday)return M.tips("请选择宝宝生日");break;case 3:}var o=0==i.status?t.api.breed_add:t.api.breed_update;n={json:JSON.stringify($.extend(n,a||{}))},M.ajax({url:o,data:{data:JSON.stringify(n)},success:function(){e.updateProfileCache(function(){history.go(-1)})}})},breedDelete:function(){var a=e.config,t=a.hashParams(),i={};t.id&&(i.babyId=t.id),confirm("确认删除？",function(){M.ajax({url:a.api.breed_delete,data:{data:JSON.stringify(i)},success:function(){e.updateProfileCache(function(){history.go(-1)})}})})},updateProfileCache:function(a){var t=e.config;t.hashParams();M.ajax({url:t.api.update_profile_cache,success:function(){a&&a(),console.info("update profile cache succeed!")}})}};module.exports=e});