define(function(require,exports,module){"use strict";var e={sku:"sku-key",active:"active",disabled:"ban"},i={delimiter:"b"};i.init=function(t){console.time("skuInit time"),i.container=$(t);var n=$(t).data("sku-map");if(n&&!i.container.data("initialized")){var a=i.skuMap={},s=$.map(n,function(e,i){return e.count||(e.count=0),i});$.each(s,function(e,t){var s=t.split(i.delimiter).sort(function(e,i){return parseInt(e)-parseInt(i)}),r=i.combineArr(s),c=n[t];$.each(r,function(e,i){a[i]?(a[i].count+=c.count,a[i].prices.push(c.price),$.unique(a[i].prices)):a[i]={count:c.count,prices:[c.price]}}),a[s.join(i.delimiter)]=$.extend(null,{count:c.count,prices:[c.price]},c)}),i.container.data("initialized",!0),console.timeEnd("skuInit time"),console.info(JSON.stringify(a));var r,c,u,l=$(".sku-price").text(),o=$(".sku-pic").attr("src"),d="请选择"+$.map(i.container.find("dl dt"),function(e){return $(e).text()}).join(",");$(".sku-desc").html(d),i.container.find("."+e.sku).each(function(){var i=$(this);a[i.data("value")]?i.removeClass(e.disabled):i.addClass(e.disabled).removeClass(e.active)}).end().off("click").on("click","."+e.sku,function(){var t=$(this);if(t.hasClass(e.disabled))return!1;t.toggleClass(e.active).siblings().removeClass(e.active);var n=i.selected();if(n.keys.length){var s=n.keys.join(i.delimiter),m=Math.min.apply(null,a[s].prices),p=Math.max.apply(null,a[s].prices);r=m===p?["￥",p].join(""):["￥",m,"-",p].join(""),a[s].itemPic&&(c=a[s].itemPic),u=$.map(n.desc,function(e,i){return"<span>"+e+"</span>"}).join("");var v=n.detail&&n.detail.limit?n.detail.limit:null;i.container.siblings(".quantity").find(".number").data("max",v).spinner();var f=$("."+e.sku).not("."+e.active).not(t);$.each(f,function(){var t=$(this),s=t.siblings("."+e.active),r=[];r=s[0]?$.grep(n.keys,function(e,i){return e!=s.data("value")}):n.keys.concat(),r=r.concat(t.data("value")).sort(function(e,i){return parseInt(e)-parseInt(i)}),a[r.join(i.delimiter)]?t.removeClass(e.disabled):t.addClass(e.disabled)})}else r=l,c=o,u=d,$.each($("."+e.sku),function(){var i=$(this);a[i.data("value")]?i.removeClass(e.disabled):i.addClass(e.disabled).removeClass(e.active)});$(".sku-price").text(r),$(".sku-pic").attr("src",c),$(".sku-desc").html(u)}),$.each($(".sku dl dd"),function(){var i=$(this).find("."+e.sku);1===i.length&&i.trigger("click")})}},i.combineArr=function(e){function t(s,r){if(s=s||"",r=r||0,r!=n)for(var c=r;c<n;c++){var u=(s?[s,i.delimiter,e[c]]:[s,e[c]]).join("");a.push(u),t(u,++r)}}var n=e.length,a=[];return t(),a},i.selected=function(){var t=i.skuMap,n=$("."+e.sku+"."+e.active),a={keys:[]};return n[0]&&(a.keys=$.map(n,function(e,i){return $(e).data("value")}).sort(function(e,i){return parseInt(e)-parseInt(i)}),a.desc=$.map(n,function(e,i){return $(e).text()}),t[a.keys.join(i.delimiter)].itemId&&(a.detail=t[a.keys.join(i.delimiter)],a.itemId=a.detail.itemId)),a},module.exports=i});