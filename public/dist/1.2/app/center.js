define(function(require,exports,module){var e={config:{api:{home:"/home",orders:"/api/orders",orderDetail:"/api/order_detail",orderResult:"/api/order_result",address:"/api/address",addressEdit:"/api/address_edit",addressGPS:"/api/address_gps",addressSearch:"/api/address_search",addressSave:"/api/address/save",addressDelete:"/api/address/delete",queryArea:"/api/address/queryArea",beans:"/api/beans",coupons:"/api/coupons",couponsExchange:"/api/coupons_exchange",integral:"/api/integral",orderExpress:"/api/order_express",orderReview:"/api/order_review",orderReviewSubmit:"/api/order/reviewSubmit",orderReviewDetail:"/api/order_review_detail",orderRebuy:"/api/order_rebuy"}},init:function(){require.async("router",e.setRouter),e.bindEvents()},bindEvents:function(){},setRouter:function(){var a=new Router({container:"#app",enter:"enter",leave:"leave",enterTimeout:250,leaveTimeout:250}),r={url:"/",render:function(e){var a=$("#tpl_home").html();e(null,a)},bind:function(){}},t={url:"/orders",className:"m-order",render:function(a){e.renderModule("orders",a)},bind:function(){var a=$(this);require.async("app/order",function(r){new r(e,a).render()})}},i={url:"/order/detail/:orderNo/:queryType?",render:function(a){this.params.queryType&&(this.params.queryType=+this.params.queryType);var r=this.params;e.renderModule("orderDetail",a,r)},bind:function(){var a=$(this);require.async("app/order",function(r){new r(e,a).render()})}},s={url:"/order/rebuy/:orderNo/:queryType?",render:function(a){this.params.queryType&&(this.params.queryType=+this.params.queryType);var r=this.params;e.renderModule("orderRebuy",a,r)},bind:function(){var a=$(this);require.async("app/order",function(r){new r(e,a).render()})}},n={url:"/order/express/:orderNo",render:function(a){var r=this.params;e.renderModule("orderExpress",a,r)},bind:function(){var e=$(this);e.on("click",".more-show",function(){var e=$(this).prev();e.toggleClass("in"),$(this).find("em").html(e.is(".in")?"隐藏商品":"显示其余"+$(this).data("num")+"件")})}},d={url:"/order/review/:orderNo",render:function(a){var r=this.params;e.renderModule("orderReview",a,r)},bind:function(){}},o={url:"/order/reviewDetail/:orderNo/:itemId?/:mbeans?",render:function(a){var r=this.params;e.renderModule("orderReviewDetail",a,r)},bind:function(){var a=$(this);a.on("click",".js-review-submit",function(){var a=$(this).data("params");if(a.content=$("#reviewCtn").val(),$("#deliverySpeedStar").length&&(a.deliverySpeedStar=+$("#deliverySpeedStar").data("star")),$("#serveStar").length&&(a.serveStar=+$("#serveStar").data("star")),$("#goodsStar").length&&(a.star=+$("#goodsStar").data("star")),""===a.content)return alert("商品评价内容为空");if(a.content.length>140)return alert("字数超出最大限制");var r=[];$(".file li .item").each(function(){r.push($(this).find("img").data("filename"))}),r.length&&(a.pics=r.toString()),M.ajax({url:e.config.api.orderReviewSubmit,data:{data:JSON.stringify(a)},success:function(e){e.success&&(location.href="/center#/order/result/"+a.orderNo+"/"+a.templateId+"/"+e.mbeanGet)}})}),a.on("click",".js-star li",function(){var e=$(this).text();$(this).closest("ol").prev().attr("class","star star-"+e).data("star",e)}),$(".js-oss-file").on("change",function(e){var a=e.target.files[0];console.log(a),$file=$(this);var r=new FormData;r.append("file",a),M.ajax({type:"post",url:"/oss/uploadImage",cache:!1,data:r,processData:!1,contentType:!1,success:function(e){console.log("res---->",JSON.stringify(e)),e.success&&($file.closest("li").before('<li><div class="item"><img src="'+e.url+'" alt="" data-filename="'+e.name+'"><del></del></div></li>'),$file.val(""),$(".file li .item").length>=5&&$file.closest("li").hide())}})}),a.on("click","del",function(){$(this).closest("li").remove(),$(".file li.item").length<5&&$file.closest("li").show()})}},c={url:"/order/result/:orderNo/:templateId?/:mbeans?",render:function(a){var r=this.params;console.log("params=======",r),e.renderModule("orderResult",a,r)},bind:function(){M.lazyLoad.init()}},l={url:"/address/:params?",className:"m-address",render:function(a){l.hashParams=M.url.getParams(this.params.params),e.renderModule("address",a,l.hashParams)},bind:function(){var e=$("#app"),a=$(this);e.data("data",null),l.hashParams.f&&a.on("click",".detail",function(){var e=$(this).data("info"),a={deliveryAddrId:e.deliveryAddrId,addr:[e.prv,e.city,e.area,e.gpsAddr,e.addrDetail].join(""),consignee:e.consignee,phone:e.phone,areaId:e.areaId,isDefult:e.isDefault};localStorage.setItem(CONST.local_settlement_addr,JSON.stringify(a)),window.history.go(-1)})}},p={url:"/addressAdd/:params?",className:"m-address-edit",render:function(){return p.hashParams=M.url.getParams(this.params.params),$("#tpl_address_add").html()},bind:function(){var a=$(this);a.data("hash-params",p.hashParams),e.updateAddressData(a),e.bindAddressEvents(a),e.selectPCD()}},u={url:"/addressEdit/:id/:params?",className:"m-address-edit",render:function(a){u.hashParams=M.url.getParams(this.params.params);var r=$.extend({},{id:+this.params.id},u.hashParams);e.renderModule("addressEdit",a,r)},bind:function(){var a=$(this);a.data("hash-params",u.hashParams),e.updateAddressData(a),e.bindAddressEvents(a),e.selectPCD()}},f={url:"/addressSearch/:areaId/:province?",className:"m-address-search",render:function(){return this.params.areaId=+this.params.areaId,f.params=this.params,$("#tpl_address_search").html()},bind:function(){var e=f.params;require.async("app/address_search",function(a){new a(e).render()})}},h={url:"/addressGps",className:"m-address-search",render:function(a){require.async("app/address_gps",function(r){new r(e,a).render()})},bind:function(){var e=$(this);e.on("click",".list li",function(){var e=$(this),a=$("#app"),r=e.data("info");AMap.service("AMap.Geocoder",function(){var t=new AMap.Geocoder,i=[r.location.lng,r.location.lat];t.getAddress(i,function(t,i){if("complete"===t&&"OK"===i.info){var s=i.regeocode,n=s.addressComponent;console.log(n),n.province=n.province.replace(/省$/,"");var d=a.data("data")||{};d.gpsAddr=e.find("dt span").text(),d.district=[n.province,n.city,n.district].join(""),d.areaId=n.adcode,d.prv=n.province,d.city=n.city,d.area=n.district,d.lat=r.location.lat,d.lng=r.location.lng,a.data("data",d),window.history.go(-1)}})})})}},v={url:"/beans",className:"m-beans",render:function(a){e.renderModule("beans",a)},bind:function(){var a=$(".m-record .list");a.children()[0]||a.data("locked",!0),$.pagination({container:".m-record .list",api:e.config.api.beans,fnSuccess:function(e,a){var r=e.data;return r.template?void a.append(r.template):a.data("locked",!0)}})}},m={url:"/integral/:type?",className:"m-integral",render:function(a){this.params.type=+this.params.type,m.params=this.params,e.renderModule("integral",a)},bind:function(){require.async("swipe",function(){M.swipe.init()});var a=$(".ui-swipe-item .list");$.each(a,function(){$(this).children()[0]||$(this).data("locked",!0)}),$.pagination({keys:{page:"pageNo"},container:".ui-swipe-item .list",api:e.config.api.integral,fnSuccess:function(e,a){var r=e.data;return r.template?void a.append(r.template):a.data("locked",!0)}})}},g={url:"/coupons",className:"m-coupon",render:function(a){e.renderModule("coupons",a)},bind:function(){require.async("swipe",function(){M.swipe.init()});var a=$(".ui-swipe-item .list");$.each(a,function(){$(this).children()[0]||$(this).data("locked",!0)}),$.pagination({container:".ui-swipe-item .list",api:e.config.api.coupons,fnSuccess:function(e,a){var r=e.data;return r.template?void a.append(r.template):a.data("locked",!0)}});var r=$(this);r.on("click",".js-exchange",function(){var a=$(this),r=a.siblings(".coupon-code").val(),t={cdKey:r};M.ajax({url:e.config.api.couponsExchange,data:{data:JSON.stringify(t)},success:function(e){e.success&&M.tips({body:"优惠券兑换成功！",callback:function(){M.reload()}})}})})}};a.push(r).push(t).push(i).push(l).push(p).push(u).push(h).push(f).push(v).push(m).push(g).push(n).push(d).push(o).push(c).push(s).setDefault("/").init()},getAddressData:function(e){var a=$("#app"),r={consignee:e.find(".name").val(),phone:e.find(".mobile").val(),district:e.find(".district").val(),areaId:e.find(".district").data("area-id")||null,prv:$("#list-pro").find("option:selected").text(),city:$("#list-city").find("option:selected").text(),area:$("#list-area").find("option:selected").text(),gpsAddr:e.find(".street").val(),lat:e.find(".street").data("lat")||null,lng:e.find(".street").data("lng")||null,addrDetail:e.find(".house-number").val(),isDefault:e.find(".isDefault").is(":checked")?1:0};console.log(JSON.stringify(r));var t=e.data("id");return t&&(r.deliveryAddrId=t),a.data("data",r),r},queryAddressArea:function(a){var r,t=[],i={pro:$("#list-pro"),city:$("#list-city"),area:$("#list-area")};switch(a.type){case 1:t.push('<option value="-1">请选择省份</option>'),r=i.pro,i.city.empty().append('<option value="-1">请选择城市</option>'),i.area.empty().append('<option value="-1">请选择区域</option>');break;case 2:t.push('<option value="-1">请选择城市</option>'),r=i.city,i.area.empty().append('<option value="-1">请选择区域</option>');break;case 3:t.push('<option value="-1">请选择区域</option>'),r=i.area}r.empty().append(t),/-1/.test(a.id)||M.ajax({showLoading:!1,url:e.config.api.queryArea,data:{data:JSON.stringify(a||{})},success:function(e){var i=e.data;$.each(i,function(e,a){t.push('<option value="'+a.id+'">'+a.name+"</option>")}),r.empty().append(t),a.callback&&a.callback()}})},selectPCD:function(){$.when(function(){var a=$.Deferred();return e.queryAddressArea({type:1,callback:function(){var e=$(".js-district");if(e.data("prv")){var r=$.grep($("#list-pro option"),function(a){return $(a).text()===e.data("prv")});$(r[0]).attr("selected",!0),a.resolve($(r[0]).val())}else a.reject()}}),a.promise()}()).then(function(a){var r=$.Deferred();return e.queryAddressArea({type:2,id:a,callback:function(){var e=$(".js-district"),a=$.grep($("#list-city option"),function(a){return $(a).text()===e.data("city")});$(a[0]).attr("selected",!0),r.resolve($(a[0]).val())}}),r.promise()}).then(function(a){e.queryAddressArea({type:3,id:a,callback:function(){var e=$(".js-district"),a=$.grep($("#list-area option"),function(a){return $(a).text()===e.data("area")});$(a[0]).attr("selected",!0)}})})},bindAddressEvents:function(a){var r=a;r.on("click",".js-district",function(){$(".u-area").addClass("show")}),r.on("click",".u-area .mask",function(){$(".u-area").removeClass("show")}),r.on("change",".fm-addr-pcd select",function(){var a={id:$(this).val()};switch(this.id){case"list-pro":a.type=2,e.queryAddressArea(a);break;case"list-city":a.type=3,e.queryAddressArea(a);break;case"list-area":}}),r.on("click",".js-confirm",function(){var a={pro:$("#list-pro"),city:$("#list-city"),area:$("#list-area")};for(var t in a){var i=a[t];if(/-1/.test(i.val()))return M.tips(i.find("option:eq(0)").text())}var s=a.area.val(),n=$.map(a,function(e){return e.find("option:selected").text()}).join("");$(".js-district").data("area-id")!==s&&($(".js-district").val(n).data({"area-id":s}),$(".house-number,.street").val("")),e.getAddressData($(".fm-addr-info")),e.updateAddressData(r),r.find(".u-area .mask").trigger("click")}),r.on("click",".js-street",function(){var a=$(".js-district");if(!a.data("area-id"))return M.tips("请先选择省市区");var r=e.getAddressData($(".fm-addr-info")),t="/center#/addressSearch/"+r.areaId+"/"+(a.data("prv")||"");location.href=t}),r.on("click",".js-gps",function(){e.getAddressData($(".fm-addr-info")),location.href="/center#/addressGps"}),r.on("click",".js-delete",function(){var a={deliveryAddrId:$(this).data("id")};confirm("您确定删除该地址吗",function(r){M.ajax({url:e.config.api.addressDelete,data:{data:JSON.stringify(a)},success:function(e){e.success&&(r.hide(),M.tips({body:"收货地址删除成功！",callback:function(){history.go(-1)}}))}})})}),r.on("click",".js-submit",function(){var a=e.getAddressData($(".fm-addr-info")),t={consignee:"请输入收货人的姓名",phone:"请输入收货人的手机号码",phone_valid:"请输入正确的手机号码",areaId:"请选择省份、城市、区域",gpsAddr:"请选择街道地址",addrDetail:"请填写门牌号等详细地址"},i=!0;return $.each(a,function(e,r){if(/(consignee|phone|gpsAddr|addrDetail)/.test(e)){if(a[e]=$.trim(r),!a[e])return M.tips(t[e]),i=!1;if(a[e].match(/\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDE4F]/g))return M.tips("不能输入特殊字符或表情"),i=!1;if(/(phone)/.test(e)&&!/^1[3,4,5,7,8]\d{9}$/.test(a[e]))return M.tips(t.phone_valid),i=!1}return/(areaId)/.test(e)&&!a[e]?(M.tips(t[e]),i=!1):/(lat|lng)/.test(e)&&!a[e]?(M.tips(t.gpsAddr),i=!1):void 0}),!!i&&void M.ajax({url:e.config.api.addressSave,data:{data:JSON.stringify(a)},success:function(e){e.success&&M.tips({body:"保存成功！",callback:function(){var t=r.data("hash-params");if(t.f){var i={deliveryAddrId:e.deliveryAddrId||a.deliveryAddrId,addr:[a.district,a.gpsAddr,a.addrDetail].join(""),consignee:a.consignee,phone:a.phone,areaId:a.areaId,isDefult:a.isDefault};localStorage.setItem(CONST.local_settlement_addr,JSON.stringify(i)),window.history.go(-2)}else window.history.go(-1)}})}})})},updateAddressData:function(module){var e=$("#app"),a=module,r=e.data("data");console.log("xxx",JSON.stringify(r)),r&&("undefined"!=typeof r.gpsAddr&&a.find(".street").val(r.gpsAddr).data({lat:r.lat,lng:r.lng}),"undefined"!=typeof r.consignee&&a.find(".name").val(r.consignee),"undefined"!=typeof r.phone&&a.find(".mobile").val(r.phone),"undefined"!=typeof r.district&&a.find(".district").val(r.district).data({"area-id":r.areaId,prv:r.prv,city:r.city,area:r.area}),"undefined"!=typeof r.addrDetail&&a.find(".house-number").val(r.addrDetail),"undefined"!=typeof r.isDefault&&a.find(".isDefault").prop("checked",!!r.isDefault))},renderModule:function(module,a,r){var t=require("app/renderSPA");t(e.config.api[module],a,r)}};e.init()});