define(function(require,exports,module){function e(){this.isWeChat=!!/MicroMessenger/gi.test(navigator.userAgent),this.isWinWeChat=!!/windowswechat/gi.test(navigator.userAgent),this.location={city:"杭州市",areaId:330102,lat:30.22965,lng:120.192567}}e.prototype.wxLocation=function(e){var c=this;return e=e||{},!c.isWeChat||c.isWinWeChat?(e.success&&e.success.call(c,c.location),!1):void require.async("weixin",function(o){c.wx=o,o.ready(function(){o.getLocation({type:"wgs84",success:function(o){console.info("[getLocation succeed]",o),c.location={lat:o.latitude,lng:o.longitude},e.success&&e.success.call(c,c.location)},fail:function(o){console.error("[getLocation failed]",o.errMsg),o.error="failed",e.fail&&e.fail.call(c,o)},cancel:function(o){console.warn("[getLocation user cancelled]",o),o.error="cancelled",e.fail&&e.fail.call(c,o)}})})})},e.prototype.searchNearBy=function(e){var c=this;e=e||{},c.wxLocation({success:function(o){AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch,i=[o.lng,o.lat];t.searchNearBy("",i,500,function(o,t){var i=[];"OK"===t.info&&(i=t.poiList.pois,i.sort(function(e,c){return e.distance-c.distance})),e.success&&e.success.call(c,i)})})},fail:function(o){e.fail&&e.fail.call(c,o)}})},e.prototype.getLocation=function(e){var c=this;require.async("cookie",function(){e=e||{};var o=$.cookie(CONST.local_cookie_location),t=new M.Base64;o&&(o=JSON.parse(t.decode(o)),e.success&&e.success.call(c,o)),c.wxLocation({success:function(i){AMap.service("AMap.Geocoder",function(){var s=new AMap.Geocoder,a=[i.lng,i.lat];s.getAddress(a,function(s,a){if(console.log(JSON.stringify(a)),"complete"===s&&"OK"===a.info){var n=a.regeocode,l=n.addressComponent,r={lng:i.lng,lat:i.lat,citycode:l.citycode,areaId:l.adcode,province:l.province,city:l.city,district:l.district,street:l.street,streetNumber:l.streetNumber,township:l.township,formattedAddress:n.formattedAddress},u=t.encode(JSON.stringify(r));o?o.city!=r.city&&M.dialog({body:"您当前的定位城市为["+r.city+"]，是否切换?",buttons:[{text:"取消"},{text:"确定",class:"success",onClick:function(){$.cookie(CONST.local_cookie_location,u,{expires:365,path:"/"}),M.reload()}}]}):e.success?($.cookie(CONST.local_cookie_location,u,{expires:365,path:"/"}),e.success.call(c,r)):M.dialog({body:"定位到当前城市："+r.city,buttons:[{text:"确定",class:"success",onClick:function(){$.cookie(CONST.local_cookie_location,u,{expires:365,path:"/"}),M.reload()}}]})}else o||e.fail&&e.fail.call(c,a)})})},fail:function(o){e.fail&&e.fail.call(c,o)}})})},module.exports=new e});